# Библиотека Weasel

Weasel - это небольшая библиотека, предназначенная для упрощения интеграционного тестирования приложений на основе
[Symfony](https://symfony.com/).

## Установка

Установите, используя [Composer](https://getcomposer.org/):

```shell
$ composer require --dev dab-libs/waesel-bundle
```

## Использование

1. Установите Weasel
2. Создайте класс тестового контекста, и опишите в нём в виде публичных полей все необходимые для теста сервисы.
   Инициализируйте эти поля через параметры конструктора
3. Создайте класс фикстуры, реализовав интерфейс Fixture. Метод createData интерфейса Fixture, который предназначен для
   создания начального состояния базы данных, будет вызван автоматически перед запуском Вашего теста
4. Опишите классы тестового контекста и фикстуры как сервисы, сделав их публичными
5. Унаследуйте тестовый класс от одного из классов из библиотеки Weasel, например, от DbTestCase
6. Опишите в этом классе поля для тестового контекста и фикстуры и пометьте их аннотацией @RequiredForTest

Теперь при запуске теста в базовом методе setUp сервисы классов тестового контекста и фикстуры будут автоматически
запрошены из контейнера зависимостей и присвоены соответствующим полям тестового класса. Затем у сервиса фикстуры будет
вызван метод createData. И уже после этого будет выполнен тестовый метод, в котором можно свободно использовать сервисы,
внедренные в тестовый контекст.

## Для чего необходима библиотека Weasel

### Интеграционные тесты вместо модульных тестов

Для большинства веб-приложений (в том числе, и основанных на Symfony) модульные тесты бесполезны. Это связанно с тем,
что приложения на основе Symfony состоят из множества сервисов. Каждый из них реализует очень простые алгоритмы, но при
этом зависит от большого количества других сервисов. Из-за этого модульные тесты зависят от большого количество
мок-объектов. К сожалению, такие тесты малоэффективны или очень хрупки.

С другой стороны, в этой ситуации интеграционные тесты позволяют протестировать процесс обработки каждого запроса. Они
помогают проверить не только алгоритмы обработки данных, но и описание сервисов, используемых в обработке запроса, и их
взаимодействие. Модульные тесты не позволяют выявить такие ошибки. Ошибки, связанные с загрузкой/выгрузкой данных из/в
базу данных, тоже не поддаётся тестированию с помощью модульных тестов, но легко выявляются при интеграционном
тестировании. При этом интеграционные тесты ломаются лишь при изменении формата или семантики входных и выходных данных.
А это случается достаточно редко.

### Сервисы Symfony в тестах без Weasel

Практически весь функционал приложений на основе Symfony реализован в виде сервисов. При тестировании эти сервисы
необходимо получить из DI-контейнера. Разработчики Symfony советуют делать это
[следующим образом](https://symfony.com/doc/current/testing.html#integration-tests):

1. инициализировать ядро Symfony,
2. получить DI-контейнер с помощью метода getContainer класса KernelTestCase,
3. получить из DI-контейнера необходимые для теста сервисы.

```php 
class NewsletterGeneratorTest extends KernelTestCase {
    public function testSomething() {
        self::bootKernel();
        $container = static::getContainer();

        $newsletterGenerator = $container->get(NewsletterGenerator::class);
        $newsletter = $newsletterGenerator->generateMonthlyNews(...);

        $this->assertEquals('...', $newsletter->getContent());
    }
}
```

### Сервисы Symfony в тестах с использованием Weasel

Для обычного Symfony-программиста получение сервиса напрямую из контейнера зависимостей является неестественной
практикой. Мы привыкли получать сервисы с помощью внедрения их через параметры конструктора или через сетеры.

Библиотека Weasel позволяет избавить программиста от явного обращения к контейнеру зависимостей, и получать все
необходимые для теста сервисы, описав их привычным путём в тестовом контексте.

## Классы Weasel 

* KernelTestCase - для интеграционных тестов без использования базы данных
* DbTestCase - для интеграционных тестов с использованием базы данных
* WebTestCase - для функциональных тестов без использования базы данных
* WebDbTestCase - для функциональных тестов с использованием базы данных
